project(SGDNN CXX)

set(SAFETY_FLAGS "-Wall -Wno-error=deprecated-declarations -ffunction-sections -fdata-sections -fPIC -Wno-unused-function -funwind-tables -fno-short-enums")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 -lpthread -fno-strict-aliasing -D_GLIBCXX_USE_CXX11_ABI=1 ${SAFETY_FLAGS}")

set(SGDNN_BACKEND_1684X 0)
set(SGDNN_BACKEND_2260 0)
if($ENV{CHIP_ARCH} STREQUAL "bm1684x")
  set(SGDNN_BACKEND_1684X 1)
  set(SGDNN_BACKEND_2260 0)
elseif($ENV{CHIP_ARCH} STREQUAL "sg2260")
  set(SGDNN_BACKEND_1684X 0)
  set(SGDNN_BACKEND_2260 1)
endif()

configure_file( 
    "${CMAKE_CURRENT_SOURCE_DIR}/include/config_sgdnn_backend.h.in"
    "${CMAKE_CURRENT_SOURCE_DIR}/include/config_sgdnn_backend.h" )

if(SOC_MODE)
  set(CMAKE_C_COMPILER $ENV{CROSS_TOOLCHAINS}/gcc-arm-10.3-2021.07-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-gcc)
  set(CMAKE_ASM_COMPILER aarch64-linux-gnu-gcc)
  set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
endif()

include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)
include_directories(${PROJECT_ROOT}/common/include)
if($ENV{LIBSOPHON_PATTERN} MATCHES $ENV{LIBSOPHON_STABLE})
  include_directories(/opt/sophon/libsophon-current/include)
elseif($ENV{LIBSOPHON_PATTERN} MATCHES $ENV{LIBSOPHON_LATEST})
  include_directories($ENV{LIBSOPHON_TOP}/bmlib/include)
elseif($ENV{LIBSOPHON_PATTERN} MATCHES $ENV{LIBSOPHON_LOCAL})
  include_directories($ENV{LIBSOPHON_TOP}/include)
endif()

if(SGDNN_BACKEND_1684X)
  include_directories(${CMAKE_BINARY_DIR}/firmware_core)
  if($ENV{LIBSOPHON_PATTERN} MATCHES $ENV{LIBSOPHON_STABLE})
    link_directories(/opt/sophon/libsophon-current/lib)
  elseif($ENV{LIBSOPHON_PATTERN} MATCHES $ENV{LIBSOPHON_LATEST})
    if(NOT EXISTS "$ENV{LIBSOPHON_TOP}/build/bmlib/libbmlib.so")
      message(WARNING           
      " NOT FOUND $ENV{LIBSOPHON_TOP}/build/bmlib/libbmlib.so,
        USE LOCAL BMLIB, Please Make Sure you want to build CModel Version")
      link_directories(${PROJECT_ROOT}/third_party/$ENV{CHIP_ARCH})
    else()
      link_directories($ENV{LIBSOPHON_TOP}/build/bmlib)
    endif()
  elseif($ENV{LIBSOPHON_PATTERN} MATCHES $ENV{LIBSOPHON_LOCAL})
    link_directories($ENV{LIBSOPHON_TOP}/$ENV{CHIP_ARCH})
  endif()
  add_library(sgdnn SHARED ${CMAKE_CURRENT_SOURCE_DIR}/src/sgdnn.cpp)
  target_link_libraries(sgdnn bmlib)
elseif(SGDNN_BACKEND_2260)
  include_directories(${PROJECT_ROOT}/third_party/include)
  if(USING_CMODEL)
    link_directories(${PROJECT_ROOT}/third_party/$ENV{CHIP_ARCH})
  else()
    message(FATAL_ERROR "sg2260 only support cmodel now!!!!")
  endif()
  add_library(sgdnn SHARED ${CMAKE_CURRENT_SOURCE_DIR}/src/sgdnn.cpp ${CMAKE_CURRENT_SOURCE_DIR}/src/tpukernel_multicore.cpp)
  target_link_libraries(sgdnn bmlib)
endif()